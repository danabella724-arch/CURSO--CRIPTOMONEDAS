<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curso de Criptomonedas – Realidad o Estafa</title>
  <meta name="description" content="Curso gratuito sobre criptomonedas: módulos, videos, preguntas, examen final y certificado descargable." />
  <style>
    :root{
      --primary:#0b409c; /* azul */
      --accent:#10b981; /* verde */
      --warn:#f97316; /* naranja */
      --bg:#f4f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;line-height:1.45}
    header{background:linear-gradient(90deg,var(--primary),#0e5bbf);color:#fff;padding:28px 16px;text-align:center}
    header h1{margin:0;font-size:22px}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .btn{display:inline-block;background:var(--primary);color:#fff;padding:10px 14px;border-radius:8px;text-decoration:none;border:none;cursor:pointer}
    .btn.secondary{background:#eef2ff;color:var(--primary);border:1px solid #dbeafe}
    .btn.warn{background:var(--warn)}
    .module-list{display:flex;flex-direction:column;gap:10px}
    .module-card{border-radius:10px;padding:12px;background:#fbfdff;border:1px solid #eef2ff;display:flex;justify-content:space-between;align-items:center}
    label{display:block;margin-top:8px;font-weight:600}
    input[type=text],input[type=email],input[type=number]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;margin-top:6px}
    .video{width:100%;height:0;padding-bottom:56%;position:relative;border-radius:8px;overflow:hidden;margin-bottom:12px}
    .video iframe{position:absolute;left:0;top:0;width:100%;height:100%;border:0}
    .question{background:#fff;padding:12px;border-radius:8px;border:1px solid #eceff8;margin-bottom:10px}
    .result{font-weight:700;margin-top:8px}
    .correct{color:green}
    .wrong{color:red}
    .small{font-size:13px;color:var(--muted)}
    .progressbar{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progressbar > i{display:block;height:100%;background:linear-gradient(90deg,var(--primary),#06b6d4);width:0%}
    footer{padding:18px;text-align:center;color:#fff;background:linear-gradient(90deg,var(--primary),#0e5bbf);margin-top:24px}
    .center{text-align:center}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:#f1f5f9;color:var(--muted);font-weight:600}
    .input-inline{padding:8px;border-radius:8px;border:1px solid #e6eef8}
    .hidden{display:none}
  </style>

  <!-- jsPDF for certificate generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>Curso de Criptomonedas — ¿Realidad o Estafa?</h1>
    <p class="small">Curso gratuito y accesible para adultos: aprende, practica y obtén tu certificado.</p>
  </header>

  <div class="wrap">
    <!-- Registro -->
    <div class="card" id="registroCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0 0 6px 0">Registro</h2>
          <div class="small muted">Ingresa tu nombre, correo y edad para guardar tu progreso y generar certificado.</div>
        </div>
        <div class="row">
          <div class="badge">Privado → Local</div>
        </div>
      </div>

      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr 120px;gap:10px">
        <div>
          <label for="nombre">Nombre completo</label>
          <input id="nombre" type="text" placeholder="Ej. María Pérez">
        </div>
        <div>
          <label for="correo">Correo electrónico</label>
          <input id="correo" type="email" placeholder="ejemplo@correo.com">
        </div>
        <div>
          <label for="edad">Edad</label>
          <input id="edad" type="number" min="12" placeholder="Edad" style="width:100%">
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" onclick="guardarRegistro()">Guardar y mostrar módulos</button>
        <button class="btn secondary" onclick="cargarRegistro()">Cargar datos guardados</button>
        <button class="btn secondary" onclick="borrarDatos()">Borrar datos</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left: contenido -->
      <main>
        <!-- Bienvenida & módulos -->
        <div class="card" id="inicioCard">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
            <div>
              <h2 style="margin:0">Bienvenido al curso</h2>
              <div class="small muted">Elige un módulo o ve al examen final. Tu progreso se guarda automáticamente en este navegador.</div>
            </div>
            <div style="text-align:right">
              <div class="small muted">Progreso general</div>
              <div class="progressbar" style="width:220px"><i id="progressBar"></i></div>
              <div class="small muted" id="progressPct">0%</div>
            </div>
          </div>

          <div style="margin-top:14px" id="modulosArea" class="module-list hidden">
            <div class="module-card">
              <div>
                <h3 style="margin:0">Módulo 1 — Introducción</h3>
                <div class="small muted">Conceptos básicos y blockchain</div>
              </div>
              <div>
                <button class="btn" onclick="openModule(1)">Ingresar</button>
              </div>
            </div>

            <div class="module-card">
              <div>
                <h3 style="margin:0">Módulo 2 — Estafas y prevención</h3>
                <div class="small muted">Identificar fraudes y protegerse</div>
              </div>
              <div>
                <button class="btn" onclick="openModule(2)">Ingresar</button>
              </div>
            </div>

            <div class="module-card">
              <div>
                <h3 style="margin:0">Módulo 3 — Uso seguro</h3>
                <div class="small muted">Wallets, claves y autenticación</div>
              </div>
              <div>
                <button class="btn" onclick="openModule(3)">Ingresar</button>
              </div>
            </div>

            <div class="module-card">
              <div>
                <h3 style="margin:0">Examen Final</h3>
                <div class="small muted">20 preguntas. Necesitas ≥7/10 para aprobar (mínimo configurable).</div>
              </div>
              <div>
                <button class="btn" onclick="openModule('final')">Ir al examen</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Module 1 -->
        <section class="card hidden" id="mod1Card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0">Módulo 1 — ¿Qué son las criptomonedas?</h2>
              <div class="small muted">Duración aprox. 6 min</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn secondary" onclick="marcarModulo(1)">Marcar completado</button>
              <button class="btn" onclick="volverInicio()">Volver</button>
            </div>
          </div>

          <div class="video" style="margin-top:12px">
            <!-- Video válido -->
            <iframe src="https://www.youtube.com/embed/6Gu2QMTAkEU" title="Introducción a Criptomonedas" allowfullscreen></iframe>
          </div>

          <p class="small">Explicación sencilla sobre Bitcoin, blockchain y tokens.</p>
          <img src="https://i.imgur.com/L2Qw2CQ.jpeg" alt="Ilustración blockchain" style="width:100%;border-radius:8px;margin-top:12px">

          <div style="margin-top:12px">
            <div class="question">
              <p><strong>1)</strong> ¿Qué es una criptomoneda?</p>
              <label><input type="radio" name="m1q1" value="correcto"> Un activo digital basado en blockchain</label><br>
              <label><input type="radio" name="m1q1" value="incorrecto"> Dinero físico del banco</label>
              <p id="m1res1" class="result"></p>
            </div>

            <button class="btn" onclick="evaluarModulo(1)">Evaluar Módulo</button>
          </div>
        </section>

        <!-- Module 2 -->
        <section class="card hidden" id="mod2Card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0">Módulo 2 — Estafas y prevención</h2>
              <div class="small muted">Duración aprox. 8 min</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn secondary" onclick="marcarModulo(2)">Marcar completado</button>
              <button class="btn" onclick="volverInicio()">Volver</button>
            </div>
          </div>

          <div class="video" style="margin-top:12px">
            <iframe src="https://www.youtube.com/embed/uf0R0bBq5Hk" title="Prevención de estafas" allowfullscreen></iframe>
          </div>

          <p class="small">Identifica señales: promesas de ganancias garantizadas, presión para invertir, apps falsas y control remoto.</p>
          <img src="https://i.imgur.com/xQILB3R.jpeg" alt="Prevencion estafas" style="width:100%;border-radius:8px;margin-top:12px">

          <div style="margin-top:12px">
            <div class="question">
              <p><strong>1)</strong> ¿Cuál es una señal clara de estafa?</p>
              <label><input type="radio" name="m2q1" value="correcto"> Promesas de ganancias garantizadas</label><br>
              <label><input type="radio" name="m2q1" value="incorrecto"> Plataforma regulada</label>
              <p id="m2res1" class="result"></p>
            </div>

            <button class="btn" onclick="evaluarModulo(2)">Evaluar Módulo</button>
          </div>
        </section>

        <!-- Module 3 -->
        <section class="card hidden" id="mod3Card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0">Módulo 3 — Uso seguro</h2>
              <div class="small muted">Duración aprox. 6 min</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn secondary" onclick="marcarModulo(3)">Marcar completado</button>
              <button class="btn" onclick="volverInicio()">Volver</button>
            </div>
          </div>

          <div class="video" style="margin-top:12px">
            <iframe src="https://www.youtube.com/embed/SSo_EIwHSd4" title="Uso seguro" allowfullscreen></iframe>
          </div>

          <p class="small">Buenas prácticas: wallets oficiales, no compartir claves, 2FA y verificación de enlaces.</p>
          <img src="https://i.imgur.com/BXFl4LX.png" alt="Claves privadas" style="width:100%;border-radius:8px;margin-top:12px">

          <div style="margin-top:12px">
            <div class="question">
              <p><strong>1)</strong> ¿Qué debes hacer con tus claves privadas?</p>
              <label><input type="radio" name="m3q1" value="correcto"> Guardarlas de forma segura y no compartirlas</label><br>
              <label><input type="radio" name="m3q1" value="incorrecto"> Enviarlas por mensaje si lo pide soporte</label>
              <p id="m3res1" class="result"></p>
            </div>

            <button class="btn" onclick="evaluarModulo(3)">Evaluar Módulo</button>
          </div>
        </section>

        <!-- Final exam -->
        <section class="card hidden" id="finalCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0">Examen Final</h2>
              <div class="small muted">20 preguntas. Necesitas <strong id="passingScore">7</strong>/10 para aprobar (nota mostrada /20).</div>
            </div>
            <div style="text-align:right">
              <div class="small muted">Temporizador (opcional)</div>
              <div class="small" id="timerDisplay">--:--</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label><input type="checkbox" id="enableTimer"> Activar temporizador (15 min)</label>
          </div>

          <div id="examArea" style="margin-top:12px"></div>

          <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
            <button class="btn" onclick="calcularFinal()">Enviar Examen</button>
            <button class="btn secondary" onclick="resetExam()">Reiniciar</button>
            <button class="btn" id="downloadCertBtn" style="display:none" onclick="generarCertificado()">Descargar Certificado</button>
          </div>

          <p id="finalScore" class="result"></p>
        </section>

      </main>

      <!-- Right column: dashboard y recursos -->
      <aside>
        <div class="card">
          <h3 style="margin:0">Tu progreso</h3>
          <div class="small muted" style="margin-top:8px">Nombre: <strong id="dashName">-</strong></div>
          <div class="small muted">Correo: <strong id="dashEmail">-</strong></div>
          <div class="small muted">Edad: <strong id="dashAge">-</strong></div>
          <div style="margin-top:10px">Módulos completados: <strong id="completedCount">0</strong>/3</div>
          <div style="margin-top:10px" class="small muted">Examen final: <span id="examState">No realizado</span></div>
          <div style="margin-top:12px"><button class="btn" onclick="irAlExamen()">Ir al examen</button></div>
          <div style="margin-top:10px"><button class="btn secondary" onclick="continuarDondeQuede()">Continuar donde quedé</button></div>
        </div>

        <div class="card">
          <h3 style="margin:0">Recursos</h3>
          <ul class="small muted" style="margin-top:8px">
            <li>Checklist de seguridad (PDF)</li>
            <li>Enlaces oficiales de denuncia</li>
            <li>Guía rápida para adultos</li>
          </ul>
        </div>

        <div class="card">
          <h3 style="margin:0">Enviar a Google Sheets (opcional)</h3>
          <div class="small muted" style="margin-top:8px">Pega la URL del WebApp (Google Apps Script) si quieres guardar registros en una hoja.</div>
          <input id="sheetUrl" type="text" placeholder="https://script.google.com/..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8;margin-top:8px">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn secondary" onclick="saveSheetUrl()">Guardar</button>
            <button class="btn" onclick="sendToSheet()">Enviar ahora</button>
          </div>
          <p id="sheetMsg" class="small muted" style="margin-top:8px"></p>
        </div>
      </aside>
    </div>
  </div>

  <footer>© 2025 — Curso de Criptomonedas. No es asesoría financiera.</footer>

  <script>
    // =============== CONFIG ===============
    const PASS_SCORE = 7;        // mínimo para aprobar (en escala que uses)
    const EXAM_TOTAL = 20;       // número de preguntas del examen
    const TIMER_MINUTES = 15;    // temporizador opcional para examen
    // ======================================

    // Preguntas del examen (20) — puedes editarlas fácilmente
    const QUESTIONS = [
      {q:"¿Qué tecnología permite que las criptomonedas funcionen?", a:["Blockchain","Powerchain","Red bancaria"], correct:0},
      {q:"¿Qué es una señal de estafa?", a:["Ganancias garantizadas","Educación gratuita","Tasas bajas"], correct:0},
      {q:"¿Qué debes hacer con tus claves privadas?", a:["No compartirlas","Compartirlas si lo pide soporte","Guardar en mensajes"], correct:0},
      {q:"¿Qué es un monedero digital (wallet)?", a:["Software para guardar cripto","Cuenta bancaria física","Tarjeta débito"], correct:0},
      {q:"¿Qué verificar antes de invertir?", a:["Regulación y reputación","El diseño del sitio","Que tenga colores llamativos"], correct:0},
      {q:"¿Qué es un token?", a:["Activo digital en una blockchain","Cupón de tienda","Documento fiscal"], correct:0},
      {q:"¿Qué significa HODL?", a:["Mantener a largo plazo","Vender al instante","Comprar con apalancamiento"], correct:0},
      {q:"¿Qué implica alto riesgo?", a:["Posible ganancia o pérdida grande","Garantía de ganancias","Ninguna volatilidad"], correct:0},
      {q:"¿Cómo funciona una estafa Ponzi?", a:["Pago con dinero de nuevos inversores","Minado legítimo","Explotación minera"], correct:0},
      {q:"Si una oferta es demasiado buena, qué haces?", a:["Desconfiar e investigar","Aceptar inmediatamente","Contactar solo por WhatsApp"], correct:0},
      {q:"¿Qué es volatilidad?", a:["Cambios rápidos en precio","Garantía de valor","Interés bancario fijo"], correct:0},
      {q:"¿Qué es una exchange regulada?", a:["Plataforma con controles y licencias","Cualquier app","Un foro de inversión"], correct:0},
      {q:"¿Qué es 2FA (autenticación de dos factores)?", a:["Una capa extra de seguridad","Un tipo de wallet","Un algoritmo de minería"], correct:0},
      {q:"¿Por qué no compartir tu semilla (seed)?", a:["Permite controlar tus fondos","Mejora la velocidad","Asegura la privacidad"], correct:0},
      {q:"¿Qué es 'cold wallet'?", a:["Wallet desconectada de internet","Wallet de teléfono","Cuenta en exchange"], correct:0},
      {q:"¿Qué es una transacción irreversible?", a:["No se puede deshacer en blockchain","Se puede revertir con contraseña","Se devuelve por el banco"], correct:0},
      {q:"¿Qué es 'wallet custodial'?", a:["Servicio que guarda claves por ti","Wallet física","Un tipo de token"], correct:0},
      {q:"¿Qué debes hacer si pierdes acceso a tu wallet?", a:["Usar la semilla de recuperación","Enviar email a soporte","Compartir claves en foro"], correct:0},
      {q:"¿Qué es 'scam' en cripto?", a:["Estafa diseñada para robar fondos","Un tipo de inversión segura","Una moneda estable"], correct:0},
      {q:"¿Cuál es una buena práctica antes de invertir?", a:["Investigar y probar con poco capital","Invertir todo de una vez","Seguir solo consejos de redes"], correct:0},
    ];

    // Estado
    let state = { name:'', email:'', age:'', completed:[], examScore:null, examTaken:false };

    // Inicialización: cargar estado/usuario desde localStorage
    (function init(){
      const u = localStorage.getItem('curso_user');
      if(u){ const user = JSON.parse(u); state.name=user.name; state.email=user.email; state.age=user.age; 
            document.getElementById('nombre').value=user.name; document.getElementById('correo').value=user.email; document.getElementById('edad').value=user.age;
            document.getElementById('modulosArea').classList.remove('hidden'); }
      const s = localStorage.getItem('curso_state');
      if(s){ const st = JSON.parse(s); state = {...state, ...st}; updateDashboard(); }
      buildExam();
    })();

    // Guarda registro
    function guardarRegistro(){
      const n = document.getElementById('nombre').value.trim();
      const e = document.getElementById('correo').value.trim();
      const a = document.getElementById('edad').value;
      if(!n || !e || !a){ alert('Completa nombre, correo y edad'); return; }
      state.name = n; state.email = e; state.age = a;
      localStorage.setItem('curso_user', JSON.stringify({name:n,email:e,age:a}));
      saveState();
      document.getElementById('modulosArea').classList.remove('hidden');
      updateDashboard();
      alert('Datos guardados. ¡Bienvenido '+n+'!');
    }

    function cargarRegistro(){
      const u = localStorage.getItem('curso_user');
      if(!u){ alert('No hay datos guardados'); return; }
      const user = JSON.parse(u);
      document.getElementById('nombre').value = user.name;
      document.getElementById('correo').value = user.email;
      document.getElementById('edad').value = user.age;
      state.name = user.name; state.email = user.email; state.age = user.age;
      document.getElementById('modulosArea').classList.remove('hidden');
      updateDashboard();
    }

    function borrarDatos(){
      if(confirm('Borrar todos los datos guardados en este navegador?')) {
        localStorage.removeItem('curso_user'); localStorage.removeItem('curso_state');
        state = { name:'', email:'', age:'', completed:[], examScore:null, examTaken:false };
        document.getElementById('nombre').value=''; document.getElementById('correo').value=''; document.getElementById('edad').value='';
        document.getElementById('modulosArea').classList.add('hidden');
        updateDashboard();
        alert('Datos borrados.');
      }
    }

    function saveState(){ localStorage.setItem('curso_state', JSON.stringify({completed:state.completed, examScore:state.examScore, examTaken:state.examTaken})); updateDashboard(); }
    function updateDashboard(){
      document.getElementById('dashName').innerText = state.name || '-';
      document.getElementById('dashEmail').innerText = state.email || '-';
      document.getElementById('dashAge').innerText = state.age || '-';
      document.getElementById('completedCount').innerText = (state.completed||[]).length;
      document.getElementById('examState').innerText = state.examTaken ? (state.examScore + '/' + QUESTIONS.length) : 'No realizado';
      const pct = Math.round(((state.completed||[]).length / 3) * 100);
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('progressPct').innerText = pct + '%';
    }

    // Navegación de módulos
    function openModule(id){
      // ocultar todo
      ['mod1Card','mod2Card','mod3Card','finalCard'].forEach(x=>document.getElementById(x).classList.add('hidden'));
      if(id === 1) document.getElementById('mod1Card').classList.remove('hidden');
      if(id === 2) document.getElementById('mod2Card').classList.remove('hidden');
      if(id === 3) document.getElementById('mod3Card').classList.remove('hidden');
      if(id === 'final') document.getElementById('finalCard').classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function volverInicio(){ window.scrollTo({top:0,behavior:'smooth'}); }

    function marcarModulo(n){
      if(!state.completed.includes(n)) state.completed.push(n);
      saveState();
      alert('Módulo '+n+' marcado como completado');
    }

    // Evaluación por módulo (simple)
    function evaluarModulo(m){
      if(m===1){ checkAnswerByName('m1q1','m1res1'); }
      if(m===2){ checkAnswerByName('m2q1','m2res1'); }
      if(m===3){ checkAnswerByName('m3q1','m3res1'); }
    }
    function checkAnswerByName(name, resultId){
      const opts = document.getElementsByName(name);
      let chosen = null;
      for(const o of opts) if(o.checked) chosen = o.value;
      if(chosen === null){ alert('Selecciona una respuesta'); return; }
      const el = document.getElementById(resultId);
      if(chosen === 'correcto'){ el.innerText = '✔ Correcto'; el.className='result correct'; }
      else { el.innerText = '✘ Incorrecto'; el.className='result wrong'; }
    }

    // ============== EXAMEN ==============
    let examTimer = null;
    let timeRemaining = 0;

    function buildExam(){
      const area = document.getElementById('examArea');
      area.innerHTML = '';
      QUESTIONS.forEach((q,i)=>{
        const div = document.createElement('div'); div.className='question';
        const p = document.createElement('p'); p.innerHTML = '<strong>'+ (i+1) +')</strong> ' + q.q;
        div.appendChild(p);
        q.a.forEach((opt,j)=>{
          const label = document.createElement('label'); label.style.display='block';
          const input = document.createElement('input'); input.type='radio'; input.name = 'f'+i; input.value = (j===q.correct)?'correcto':'incorrecto';
          label.appendChild(input); label.appendChild(document.createTextNode(' '+opt));
          div.appendChild(label);
        });
        area.appendChild(div);
      });
    }

    function calcularFinal(){
      // if timer enabled, stop it
      if(document.getElementById('enableTimer').checked && examTimer) { clearInterval(examTimer); examTimer = null; document.getElementById('timerDisplay').innerText = '00:00'; }

      let score = 0;
      for(let i=0;i<QUESTIONS.length;i++){
        const opts = document.getElementsByName('f'+i);
        for(const o of opts) if(o.checked && o.value === 'correcto') score++;
      }
      state.examScore = score;
      state.examTaken = true;
      saveState();

      const fs = document.getElementById('finalScore');
      fs.innerHTML = 'Tu nota: <strong>' + score + '/' + QUESTIONS.length + '</strong>';
      if(score >= PASS_SCORE) {
        fs.innerHTML += ' <span style="color:green;font-weight:700">¡Aprobaste!</span>';
        document.getElementById('downloadCertBtn').style.display = 'inline-block';
      } else {
        fs.innerHTML += ' <span style="color:red;font-weight:700">No aprobaste.</span>';
        document.getElementById('downloadCertBtn').style.display = 'none';
      }
      updateDashboard();
      maybeAutoSend();
      // scroll to result
      fs.scrollIntoView({behavior:'smooth'});
    }

    function resetExam(){
      for(let i=0;i<QUESTIONS.length;i++){
        const opts = document.getElementsByName('f'+i);
        for(const o of opts) o.checked = false;
      }
      document.getElementById('finalScore').innerText = '';
      document.getElementById('downloadCertBtn').style.display = 'none';
      // reset timer
      if(examTimer){ clearInterval(examTimer); examTimer=null; document.getElementById('timerDisplay').innerText='--:--'; }
    }

    // Timer functionality
    function startTimerIfNeeded(){
      if(!document.getElementById('enableTimer').checked) return;
      // 15 minutes
      timeRemaining = TIMER_MINUTES * 60;
      document.getElementById('timerDisplay').innerText = formatTime(timeRemaining);
      examTimer = setInterval(()=>{
        timeRemaining--;
        document.getElementById('timerDisplay').innerText = formatTime(timeRemaining);
        if(timeRemaining <= 0){ clearInterval(examTimer); examTimer = null; alert('Tiempo agotado. Se enviará lo que hayas respondido.'); calcularFinal(); }
      },1000);
    }
    function formatTime(sec){
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = (sec%60).toString().padStart(2,'0');
      return m+':'+s;
    }

    // ============== CERTIFICATE (jsPDF) ==============
    async function generarCertificado(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt',format:'a4'});
      const fecha = new Date().toLocaleDateString();
      const nombre = state.name || document.getElementById('nombre').value || 'Estudiante';
      const correo = state.email || document.getElementById('correo').value || '';
      const nota = state.examScore || 0;

      // background header
      doc.setFillColor(11,64,156); doc.rect(0,0,595,90,'F');
      doc.setTextColor(255,255,255); doc.setFontSize(20); doc.text('Certificado de finalización', 40,60);
      // body
      doc.setTextColor(0,0,0); doc.setFontSize(14); doc.text('Otorgado a:',40,140);
      doc.setFontSize(18); doc.text(nombre,40,170);
      doc.setFontSize(12); doc.text('Correo: ' + correo,40,200);
      doc.text('Curso: Criptomonedas — ¿Realidad o Estafa?',40,230);
      doc.text('Puntuación: ' + nota + ' / ' + QUESTIONS.length,40,260);
      doc.text('Fecha: ' + fecha,40,290);

      doc.setFontSize(10); doc.text('No es asesoría financiera. Proyecto educativo.',40,520);
      doc.save('Certificado_' + nombre.replace(/\s+/g,'_') + '.pdf');
    }

    // ============== Google Sheets (optional) ==============
    function saveSheetUrl(){
      const u = document.getElementById('sheetUrl').value.trim();
      if(!u){ alert('Pega la URL del WebApp de Google Apps Script'); return; }
      localStorage.setItem('sheet_url', u);
      document.getElementById('sheetMsg').innerText = 'URL guardada en este navegador.';
    }

    async function sendToSheet(){
      const url = localStorage.getItem('sheet_url');
      if(!url){ alert('No hay URL guardada'); return; }
      const payload = { name: state.name, email: state.email, age: state.age, score: state.examScore || '', date: new Date().toISOString(), completed: state.completed.join(',') };
      try{
        const res = await fetch(url, { method:'POST', body: JSON.stringify(payload), headers: {'Content-Type':'application/json'} });
        if(res.ok) document.getElementById('sheetMsg').innerText = 'Enviado correctamente.';
        else document.getElementById('sheetMsg').innerText = 'Error al enviar.';
      }catch(e){ document.getElementById('sheetMsg').innerText = 'Error de red.'; }
    }

    function maybeAutoSend(){
      const url = localStorage.getItem('sheet_url');
      if(url) sendToSheet();
    }

    // ============== Utilities ==============
    function irAlExamen(){ openModule('final'); window.scrollTo({top:0,behavior:'smooth'}); }
    function continuarDondeQuede(){
      // if user has modules completed, try to open next incomplete
      const done = state.completed || [];
      if(done.length === 0) openModule(1);
      else {
        for(let i=1;i<=3;i++){
          if(!done.includes(i)){ openModule(i); return; }
        }
        openModule('final');
      }
    }

    // Callbacks when opening final: build exam and maybe start timer
    (function attachExamBuild(){
      // when user opens final, start timer if enabled
      const finalBtn = document.querySelectorAll('[onclick*="openModule(\'final\')"], [onclick*="openModule(\\'final\\')"]');
      // also intercept openModule to check timer
      const orig = openModule;
      openModule = function(n){
        orig(n);
        if(n === 'final'){
          buildExam(); // ensure exam re-built
          startTimerIfNeeded();
          document.getElementById('timerDisplay').innerText = document.getElementById('enableTimer').checked ? formatTime(TIMER_MINUTES*60) : '--:--';
        }
      };
    })();

    // expose for debugging
    window.generarCertificado = generarCertificado;
    window.marcarModulo = marcarModulo;
  </script>
</body>
</html>
